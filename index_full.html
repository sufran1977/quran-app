<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📖 اختبار حفظ القرآن – نسخة القرآن الكامل</title>
<style>
  :root{
    --bg:#eaf4ec; --fg:#1f2937; --green:#197a3a; --green-light:#d9f0de;
    --card:#fff; --muted:#6b7280; --shadow:0 10px 24px rgba(0,0,0,.08);
    --ok:#16a34a; --bad:#ef4444; --accent:#e3b04b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:"Amiri","Noto Naskh Arabic",serif}
  header{text-align:center;padding:24px 16px;}
  h1{margin:0 0 8px;font-size:26px;color:var(--green);}
  .sub{color:var(--muted)}
  .wrap{max-width:1000px;margin:0 auto;padding:0 16px 28px;}
  .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:20px;margin:14px auto;}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{color:var(--muted);font-size:14px}
  select,input{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:15px}
  input[type=number]{width:100px;text-align:center}
  .btn{border:none;border-radius:12px;padding:12px 18px;font-size:16px;cursor:pointer}
  .btn-green{background:var(--green);color:#fff}
  .btn-ghost{background:#fff;border:1px solid #e5e7eb;color:var(--fg)}
  .banner{background:var(--green-light);color:var(--green);font-weight:bold;
    font-size:22px;padding:10px 12px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.08);
    margin-bottom:12px;}
  .timer{font-weight:700;color:var(--green);font-size:18px;margin-bottom:10px;text-align:center}
  .big{font-size:24px;line-height:2.2;text-align:center}
  .note{color:var(--muted);font-size:14px;text-align:center}
  .list{list-style:none;margin:0;padding:0}
  .hidden-ellipses{color:#94a3b8}
  .center{text-align:center}
  #quizView,#resultView{display:none}
  .footer{margin-top:18px;color:#60727a;font-size:12px;text-align:center}
</style>
</head>
<body>

<header>
  <h1>📖 اختبار حفظ القرآن – نسخة القرآن الكامل</h1>
  <div class="sub">من إعداد المعلم <b>عبد الله بن حسين القحطاني</b> – مدرسة المجيدية الثانوية بالقطيف</div>
</header>

<div class="wrap">

  <!-- إعدادات النطاق -->
  <section id="setupView" class="card">
    <h2 style="margin-top:0;color:var(--green);text-align:center">إعدادات النطاق والإختبار</h2>
    <div class="row">
      <label for="surahSel">السورة</label>
      <select id="surahSel"></select>

      <label for="fromAyah">من آية</label>
      <input id="fromAyah" type="number" min="1" value="1">

      <label for="toAyah">إلى آية</label>
      <input id="toAyah" type="number" min="1" value="7">
    </div>

    <div class="row" style="margin-top:10px">
      <label for="qWords">عدد كلمات السؤال</label>
      <input id="qWords" type="number" min="1" value="12">

      <label for="aWords">عدد كلمات الإجابة (الفراغات)</label>
      <input id="aWords" type="number" min="1" value="3">

      <label for="qCount">عدد الأسئلة</label>
      <input id="qCount" type="number" min="1" value="10">

      <label for="seconds">المدة (ث)</label>
      <input id="seconds" type="number" min="5" value="20">
    </div>

    <div class="center" style="margin-top:14px">
      <button id="startBtn" class="btn btn-green">ابدأ الاختبار</button>
    </div>

    <div class="footer">
      <div>النص القرآني بالرسم العثماني من مشروع Tanzil.net — © 2007–2021 Tanzil Project — ترخيص CC BY 3.0. لا يُسمح بتغيير النص.</div>
      <div>المصدر: <a href="http://tanzil.net" target="_blank" rel="noopener">tanzil.net</a></div>
    </div>
  </section>

  <!-- صفحة الاختبار -->
  <section id="quizView" class="card">
    <div class="banner">📘 أكمل الفراغات التالية من حفظك</div>
    <div class="timer">⏳ الوقت المتبقي: <span id="remaining">--</span> ثانية</div>
    <div id="rangeLabel" class="note" style="margin-bottom:8px"></div>
    <div id="questionText" class="big"></div>
    <div id="progressText" class="note" style="margin-top:6px;"></div>
    <div class="center" style="margin-top:14px;">
      <button id="flipBtn" class="btn btn-ghost" style="border:1px solid #e5e7eb">أظهر الإجابة</button>
    </div>
    <div id="answerArea" style="display:none;margin-top:12px;">
      <div id="answerText" class="big"></div>
      <div class="center" style="margin-top:10px;">
        <button id="okBtn" class="btn" style="background:#16a34a;color:#fff;margin-inline:6px">✅ صواب</button>
        <button id="badBtn" class="btn" style="background:#ef4444;color:#fff;margin-inline:6px">❌ خطأ</button>
      </div>
    </div>
  </section>

  <!-- صفحة النتيجة -->
  <section id="resultView" class="card center">
    <h2 style="margin-top:0;color:var(--green)">نتيجتك</h2>
    <h3 id="finalScore" style="color:var(--green)"></h3>
    <div style="color:var(--green);margin:6px 0;">🌿 <em>أحسنت! واصل المراجعة لتتقن الحفظ أكثر.</em></div>
    <div class="note">يمكنك إعادة الاختبار لتقويم حفظك مرة أخرى.</div>
    <div style="margin-top:12px;">
      <button id="againBtn" class="btn btn-green">إعادة الاختبار نفسه</button>
      <button id="backBtn" class="btn btn-ghost">🔁 العودة للإعدادات</button>
    </div>
    <div class="footer">
      النص القرآني بالرسم العثماني من مشروع Tanzil.net — © 2007–2021 Tanzil Project — ترخيص CC BY 3.0. لا يُسمح بتغيير النص. المصدر: <a href="http://tanzil.net" target="_blank" rel="noopener">tanzil.net</a>
    </div>
  </section>

</div>

<audio id="beep">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
let QURAN = null;

const setupView = document.getElementById('setupView');
const quizView  = document.getElementById('quizView');
const resultView= document.getElementById('resultView');

const surahSel = document.getElementById('surahSel');
const fromAyah = document.getElementById('fromAyah');
const toAyah   = document.getElementById('toAyah');

const qWords   = document.getElementById('qWords');
const aWords   = document.getElementById('aWords');
const qCount   = document.getElementById('qCount');
const seconds  = document.getElementById('seconds');

const startBtn = document.getElementById('startBtn');

const rangeLabel   = document.getElementById('rangeLabel');
const remainingEl  = document.getElementById('remaining');
const questionText = document.getElementById('questionText');
const progressText = document.getElementById('progressText');
const flipBtn      = document.getElementById('flipBtn');
const okBtn        = document.getElementById('okBtn');
const badBtn       = document.getElementById('badBtn');
const answerArea   = document.getElementById('answerArea');
const answerText   = document.getElementById('answerText');

const finalScore = document.getElementById('finalScore');
const againBtn   = document.getElementById('againBtn');
const backBtn    = document.getElementById('backBtn');
const beep       = document.getElementById('beep');

function show(id){
  setupView.style.display = (id==='setup') ? 'block' : 'none';
  quizView.style.display  = (id==='quiz')  ? 'block' : 'none';
  resultView.style.display= (id==='result')? 'block' : 'none';
}

async function loadQuran(){
  const res = await fetch('quran.json');
  QURAN = await res.json();
  // populate surah select
  surahSel.innerHTML = '';
  QURAN.surahs.forEach(s => {
    const opt = document.createElement('option');
    const name = s.name_ar && s.name_ar.trim().length>0 ? s.name_ar : ('سورة رقم ' + s.index);
    opt.value = s.index;
    opt.textContent = `${s.index}. ${name} (آيات: ${s.ayah_count})`;
    surahSel.appendChild(opt);
  });
  surahSel.addEventListener('change', onSurahChange);
  onSurahChange();
}

function onSurahChange(){
  const s = getCurrentSurah();
  fromAyah.value = 1;
  toAyah.value   = s.ayah_count || 1;
  fromAyah.max = s.ayah_count || 1;
  toAyah.max   = s.ayah_count || 1;
}

function getCurrentSurah(){
  const idx = parseInt(surahSel.value || '1', 10);
  return QURAN.surahs.find(s => s.index === idx) || QURAN.surahs[0];
}

let words = [];
let indices = [];
let current = 0;
let correct = 0;
let timerId = null;
let remaining = 0;

startBtn.onclick = () => {
  const s = getCurrentSurah();
  const fa = Math.max(1, Math.min(parseInt(fromAyah.value||'1',10), s.ayah_count||1));
  const ta = Math.max(1, Math.min(parseInt(toAyah.value||'1',10), s.ayah_count||1));
  const a = Math.min(fa, ta), b = Math.max(fa, ta);

  const qW = Math.max(1, parseInt(qWords.value||'12',10));
  const aW = Math.max(1, parseInt(aWords.value||'3',10));
  const qc = Math.max(1, parseInt(qCount.value||'10',10));
  const sec= Math.max(5, parseInt(seconds.value||'20',10));

  // join selected ayahs into words
  const subAyahs = s.ayahs.slice(a-1, b);
  words = subAyahs.join(' ').split(/\s+/);

  // pick start indices
  indices = [];
  const maxStart = Math.max(0, words.length - (qW + aW));
  const need = Math.min(qc, maxStart) || 0;
  if(need === 0){
    alert('النطاق قصير مقارنة بإعدادات السؤال/الإجابة. زد النطاق أو قلّل الإعدادات.');
    return;
  }
  while(indices.length < need){
    const r = Math.floor(Math.random() * Math.max(1, maxStart));
    if(!indices.includes(r)) indices.push(r);
    if(maxStart===0) break;
  }

  // save settings to localStorage
  localStorage.setItem('qs_settings', JSON.stringify({surah:s.index, from:a, to:b, qW, aW, qc, sec}));

  // prepare UI
  rangeLabel.textContent = `السورة ${s.index}، من آية ${a} إلى آية ${b}`;
  settings = { qW, aW, qc: need, sec };
  current = 0; correct = 0;
  show('quiz');
  renderCard();
};

let settings = { qW:12, aW:3, qc:10, sec:20 };

function renderCard(){
  if(current >= indices.length){ finish(); return; }
  const i = indices[current];
  const head = words.slice(i, i + settings.qW).join(' ');
  const tail = words.slice(i + settings.qW, i + settings.qW + settings.aW).join(' ');

  const blanks = (' ______').repeat(settings.aW);
  questionText.innerHTML = `<b>${head}</b>${blanks}`;
  answerText.textContent = tail;
  answerArea.style.display = 'none';
  progressText.textContent = `السؤال ${current+1} من ${indices.length}`;

  clearInterval(timerId);
  remaining = settings.sec;
  remainingEl.textContent = remaining;
  timerId = setInterval(()=>{
    remaining--;
    remainingEl.textContent = remaining;
    if(remaining<=0){
      clearInterval(timerId);
      beep.play();
      next(false);
    }
  }, 1000);
}

flipBtn.onclick = () => { answerArea.style.display='block'; clearInterval(timerId); };
okBtn.onclick   = () => next(true);
badBtn.onclick  = () => next(false);

function next(isCorrect){
  clearInterval(timerId);
  if(isCorrect) correct++;
  current++;
  renderCard();
}

function finish(){
  show('result');
  finalScore.textContent = `النتيجة: ${correct} من ${indices.length}`;
}

againBtn.onclick = () => {
  // إعادة نفس النطاق لكن بنقاط بداية جديدة
  if(indices.length===0){ show('setup'); return; }
  const s = getCurrentSurah();
  const sSettings = JSON.parse(localStorage.getItem('qs_settings')||'{}');
  const qW = sSettings.qW || settings.qW;
  const aW = sSettings.aW || settings.aW;
  const qc = sSettings.qc || settings.qc;
  const sec= sSettings.sec|| settings.sec;

  words = s.ayahs.slice((sSettings.from||1)-1, (sSettings.to||1)).join(' ').split(/\s+/);
  indices = [];
  const maxStart = Math.max(0, words.length - (qW + aW));
  const need = Math.min(qc, maxStart) || 0;
  while(indices.length < need){
    const r = Math.floor(Math.random() * Math.max(1, maxStart));
    if(!indices.includes(r)) indices.push(r);
    if(maxStart===0) break;
  }
  settings = { qW, aW, qc: need, sec };
  current = 0; correct = 0;
  show('quiz');
  renderCard();
};

backBtn.onclick = () => show('setup');

// init
show('setup');
loadQuran();
</script>
</body>
</html>
